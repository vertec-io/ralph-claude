# Ralph Progress Log
Effort: ralph-activity-control
Type: Feature
Started: 2026-01-21
---

## Codebase Patterns
- ralph-tui has multiple render functions for different views (run, run_delay, run_attach_mode)
- Each view renders its own header, so changes need to be applied in multiple places
- AMBER_WARNING color constant is available from theme.rs for warning/attention indicators
- portable_pty CommandBuilder.env() is used to set environment variables for spawned processes
- YOLO_MODE is passed as an environment variable from ralph.sh to agent scripts
- Activities in PtyState are stored newest-first via get_activities() which reverses the internal list
- Activity scrolling: scroll_offset=0 means newest items, higher offset shows older items
- View modes (list/detail) should use separate state tracking (e.g., ActivityViewMode enum)
- Selected item index should be synchronized with scroll offset for predictable navigation
- Input modes (normal/modal) use InputMode enum for state tracking
- Modal overlays are rendered at the end of the draw closure to appear on top
- write_to_pty() sends bytes directly to the agent's stdin
- Ctrl+modifier key handlers must come before mode-specific handling in key event processing

---

## 2026-01-21 12:15 - US-005
- Implemented pause iteration and inject prompt feature with Ctrl+P keybind
- Added InputMode enum (Normal/PromptInput) to track modal state
- Added input_buffer, input_cursor fields to App struct for text input handling
- Created centered modal overlay with ROUNDED_BORDERS and AMBER_WARNING styling
- Modal shows input line with cursor indicator and hint line for keybindings
- Ctrl+P opens modal, Enter sends message to agent stdin, Esc cancels
- Added [PAUSED] indicator and pause icon (⏸) in header when modal is open
- Input handling supports: typing, backspace, delete, left/right arrows, home/end
- Message sent to PTY with trailing \r (carriage return) to simulate Enter
- Files changed: ralph-tui/src/main.rs, tasks/ralph-activity-control/prd.json
- **Learnings for future iterations:**
  - Modal input handling must be checked before mode-specific handlers (takes priority)
  - Use `continue` after handling modal input to skip normal key processing
  - Ctrl+modifier keys need to be checked with key.modifiers.contains()
  - Modal rendering goes at the end of draw closure to overlay on all content
  - Send \r to PTY to simulate Enter key after text input

---

## 2026-01-21 11:30 - US-004
- Implemented activity detail view with Enter to expand and Esc to return
- Added ActivityViewMode enum (List/Detail) for tracking view state
- Extended Activity struct with output and duration fields for detailed information
- Detail view shows: action type, target (full path wrapped), timestamp, duration (if available)
- For bash commands: displays truncated output (up to 2000 chars, max 5 lines visible)
- For file operations: shows descriptive operation result text
- Added selected_activity_index and activity_detail_scroll_offset to App struct
- Highlight selected activity with ▸ indicator in list view when focused
- Implemented j/k and PgUp/PgDn scrolling in detail view
- Updated hints panel to show context-aware keybindings for detail view mode
- Files changed: ralph-tui/src/main.rs, tasks/ralph-activity-control/prd.json
- **Learnings for future iterations:**
  - View modes (list/detail) should use separate state tracking enum
  - Selected item index must be synchronized with scroll offset during navigation
  - Detail view needs separate scroll offset from list view scroll offset
  - Hints panel should show different keys for each view mode state
  - Esc key needs to handle multiple levels: detail view -> list view -> unfocus panel

---

## 2026-01-21 10:45 - US-003
- Implemented scrollable activity history panel with full history (up to 1000 activities)
- Added timestamp field to Activity struct with format_timestamp() method for relative timestamps
- Added activity_scroll_offset, activity_user_scrolled, activity_panel_focused, last_activity_count fields to App struct
- Updated activity panel rendering to show timestamps in [MM:SS] format relative to iteration start
- Implemented 'a' keybinding to toggle activity panel focus for scrolling
- j/k and arrow keys scroll activities when panel is focused, scroll stories when not focused
- Auto-scroll behavior: scrolls to show newest activities unless user has manually scrolled up
- Updated hints panel to show context-aware keybindings based on activity focus state
- Files changed: ralph-tui/src/main.rs, tasks/ralph-activity-control/prd.json
- **Learnings for future iterations:**
  - Activities are returned newest-first from get_activities(), so scroll_offset=0 shows newest
  - User scroll tracking (activity_user_scrolled) allows disabling auto-scroll when user explores history
  - Focus state pattern: activity_panel_focused determines which panel receives j/k navigation
  - Hints area dynamically changes content based on current focus state

---

## 2026-01-21 09:30 - US-002
- Implemented --yolo flag in ralph-tui CLI argument parsing
- Added yolo_mode field to CliConfig struct and App struct
- Updated spawn_claude() to set YOLO_MODE=true and OPENCODE_PERMISSION env vars when yolo mode enabled
- Added [YOLO] indicator in TUI header (appears in amber color next to "RALPH LOOP")
- Updated all 3 header render locations: main run(), delay view, and attach mode view
- Files changed: ralph-tui/src/main.rs, tasks/ralph-activity-control/prd.json
- **Learnings for future iterations:**
  - ralph-tui has multiple render functions for different views (run, run_delay, run_attach_mode)
  - Each view renders its own header, so changes need to be applied in multiple places
  - AMBER_WARNING color constant is available from theme.rs for warning/attention indicators
  - portable_pty CommandBuilder.env() is used to set environment variables for spawned processes
---

## 2026-01-21 08:15 - US-001
- Implemented --yolo flag for permissive mode in ralph.sh
- Added YOLO_MODE environment variable handling
- Updated agents/opencode.sh to set OPENCODE_PERMISSION with permissive JSON when YOLO_MODE=true
- Added help text documentation for --yolo flag
- Ensured flag passes through to tmux session environment
- Files changed: ralph.sh, agents/opencode.sh
- **Learnings for future iterations:**
  - YOLO_MODE is passed as an environment variable from ralph.sh to agent scripts
  - OPENCODE_PERMISSION env var controls opencode's permission prompts
  - Permissive JSON format: {"*": "allow", "external_directory": "allow", "doom_loop": "allow"}
---
