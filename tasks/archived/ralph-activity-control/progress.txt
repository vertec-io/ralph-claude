# Ralph Progress Log
Effort: ralph-activity-control
Type: Feature
Started: 2026-01-21
---

## Codebase Patterns
- ralph-tui has multiple render functions for different views (run, run_delay, run_attach_mode)
- Each view renders its own header, so changes need to be applied in multiple places
- AMBER_WARNING color constant is available from theme.rs for warning/attention indicators
- portable_pty CommandBuilder.env() is used to set environment variables for spawned processes
- YOLO_MODE is passed as an environment variable from ralph.sh to agent scripts
- Activities in PtyState are stored newest-first via get_activities() which reverses the internal list
- Activity scrolling: scroll_offset=0 means newest items, higher offset shows older items
- View modes (list/detail) should use separate state tracking (e.g., ActivityViewMode enum)
- Selected item index should be synchronized with scroll offset for predictable navigation
- Input modes (normal/modal) use InputMode enum for state tracking
- Modal overlays are rendered at the end of the draw closure to appear on top
- write_to_pty() sends bytes directly to the agent's stdin
- Ctrl+modifier key handlers must come before mode-specific handling in key event processing
- Multi-line text editing uses Vec<String> for buffer with line_index and cursor tracking
- prd_needs_reload flag triggers PRD refresh after external file changes
- Toast notifications use Option<Instant> with elapsed() check for timeout display
- tmux send-keys -l sends literal text; without -l interprets keys like "Enter"
- tmux attach-session takes over stdio: disable_raw_mode/LeaveAlternateScreen before, restore after
- Attach mode: store tmux capture content in PtyState.recent_output and call update_activities()

---

## 2026-01-21 12:15 - US-005
- Implemented pause iteration and inject prompt feature with Ctrl+P keybind
- Added InputMode enum (Normal/PromptInput) to track modal state
- Added input_buffer, input_cursor fields to App struct for text input handling
- Created centered modal overlay with ROUNDED_BORDERS and AMBER_WARNING styling
- Modal shows input line with cursor indicator and hint line for keybindings
- Ctrl+P opens modal, Enter sends message to agent stdin, Esc cancels
- Added [PAUSED] indicator and pause icon (⏸) in header when modal is open
- Input handling supports: typing, backspace, delete, left/right arrows, home/end
- Message sent to PTY with trailing \r (carriage return) to simulate Enter
- Files changed: ralph-tui/src/main.rs, tasks/ralph-activity-control/prd.json
- **Learnings for future iterations:**
  - Modal input handling must be checked before mode-specific handlers (takes priority)
  - Use `continue` after handling modal input to skip normal key processing
  - Ctrl+modifier keys need to be checked with key.modifiers.contains()
  - Modal rendering goes at the end of draw closure to overlay on all content
  - Send \r to PTY to simulate Enter key after text input

---

## 2026-01-21 11:30 - US-004
- Implemented activity detail view with Enter to expand and Esc to return
- Added ActivityViewMode enum (List/Detail) for tracking view state
- Extended Activity struct with output and duration fields for detailed information
- Detail view shows: action type, target (full path wrapped), timestamp, duration (if available)
- For bash commands: displays truncated output (up to 2000 chars, max 5 lines visible)
- For file operations: shows descriptive operation result text
- Added selected_activity_index and activity_detail_scroll_offset to App struct
- Highlight selected activity with ▸ indicator in list view when focused
- Implemented j/k and PgUp/PgDn scrolling in detail view
- Updated hints panel to show context-aware keybindings for detail view mode
- Files changed: ralph-tui/src/main.rs, tasks/ralph-activity-control/prd.json
- **Learnings for future iterations:**
  - View modes (list/detail) should use separate state tracking enum
  - Selected item index must be synchronized with scroll offset during navigation
  - Detail view needs separate scroll offset from list view scroll offset
  - Hints panel should show different keys for each view mode state
  - Esc key needs to handle multiple levels: detail view -> list view -> unfocus panel

---

## 2026-01-21 10:45 - US-003
- Implemented scrollable activity history panel with full history (up to 1000 activities)
- Added timestamp field to Activity struct with format_timestamp() method for relative timestamps
- Added activity_scroll_offset, activity_user_scrolled, activity_panel_focused, last_activity_count fields to App struct
- Updated activity panel rendering to show timestamps in [MM:SS] format relative to iteration start
- Implemented 'a' keybinding to toggle activity panel focus for scrolling
- j/k and arrow keys scroll activities when panel is focused, scroll stories when not focused
- Auto-scroll behavior: scrolls to show newest activities unless user has manually scrolled up
- Updated hints panel to show context-aware keybindings based on activity focus state
- Files changed: ralph-tui/src/main.rs, tasks/ralph-activity-control/prd.json
- **Learnings for future iterations:**
  - Activities are returned newest-first from get_activities(), so scroll_offset=0 shows newest
  - User scroll tracking (activity_user_scrolled) allows disabling auto-scroll when user explores history
  - Focus state pattern: activity_panel_focused determines which panel receives j/k navigation
  - Hints area dynamically changes content based on current focus state

---

## 2026-01-21 09:30 - US-002
- Implemented --yolo flag in ralph-tui CLI argument parsing
- Added yolo_mode field to CliConfig struct and App struct
- Updated spawn_claude() to set YOLO_MODE=true and OPENCODE_PERMISSION env vars when yolo mode enabled
- Added [YOLO] indicator in TUI header (appears in amber color next to "RALPH LOOP")
- Updated all 3 header render locations: main run(), delay view, and attach mode view
- Files changed: ralph-tui/src/main.rs, tasks/ralph-activity-control/prd.json
- **Learnings for future iterations:**
  - ralph-tui has multiple render functions for different views (run, run_delay, run_attach_mode)
  - Each view renders its own header, so changes need to be applied in multiple places
  - AMBER_WARNING color constant is available from theme.rs for warning/attention indicators
  - portable_pty CommandBuilder.env() is used to set environment variables for spawned processes
---

## 2026-01-21 08:15 - US-001
- Implemented --yolo flag for permissive mode in ralph.sh
- Added YOLO_MODE environment variable handling
- Updated agents/opencode.sh to set OPENCODE_PERMISSION with permissive JSON when YOLO_MODE=true
- Added help text documentation for --yolo flag
- Ensured flag passes through to tmux session environment
- Files changed: ralph.sh, agents/opencode.sh
- **Learnings for future iterations:**
  - YOLO_MODE is passed as an environment variable from ralph.sh to agent scripts
  - OPENCODE_PERMISSION env var controls opencode's permission prompts
  - Permissive JSON format: {"*": "allow", "external_directory": "allow", "doom_loop": "allow"}
---

## 2026-01-21 13:00 - US-006
- Implemented switch to interactive mode feature with Ctrl+I keybind
- Reused existing Mode::Claude for interactive mode (all input already forwarded to PTY)
- Updated visual indicators to clearly show INTERACTIVE MODE:
  - Left panel title shows "[INTERACTIVE]" in green when in interactive mode
  - Claude terminal title shows "[INTERACTIVE MODE]" in bold green
  - Footer shows "INTERACTIVE MODE" in bold green instead of "Monitoring"
  - Right panel border uses GREEN_ACTIVE color when interactive
- Updated footer keybinding hints to show "^I: Interactive" and "Esc: Return to Monitoring"
- Ctrl+I handler added before mode-specific handling (like Ctrl+P pattern)
- Files changed: ralph-tui/src/main.rs, tasks/ralph-activity-control/prd.json
- **Learnings for future iterations:**
  - GREEN_ACTIVE color constant is effective for highlighting active/interactive states
  - Mode::Claude already handled forwarding all input to PTY except Esc
  - Footer bar mode_text can be dynamically colored based on mode
  - Modifier::empty() returns no modifiers for conditional modifier application

---

## 2026-01-21 14:30 - US-007
- Implemented edit PRD notes mid-run feature with 'n' keybind
- Added InputMode::NotesEdit variant for tracking notes editor modal state
- Added notes_buffer (Vec<String>), notes_line_index, notes_cursor fields to App struct for multi-line editing
- Added notes_saved_confirmation (Option<Instant>) for showing save confirmation toast
- Created update_story_notes() function to append notes to story's notes field in prd.json
- Modal features:
  - Multi-line text editing with Enter for new lines
  - Arrow keys for navigation (up/down changes lines, left/right within line)
  - Backspace/Delete with line merging behavior
  - Home/End for line start/end
  - Ctrl+S to save and close
  - Esc to cancel without saving
- Notes are appended to existing notes (preserving previous content)
- Green toast notification appears for 2 seconds after successful save
- PRD reload flag is set after save so TUI reflects changes
- Files changed: ralph-tui/src/main.rs, tasks/ralph-activity-control/prd.json
- **Learnings for future iterations:**
  - Multi-line text editing requires Vec<String> buffer with separate line/cursor tracking
  - serde_json::Value allows modifying JSON without full type deserialization
  - Use prd_needs_reload flag to trigger PRD refresh after file changes
  - Toast notifications use Option<Instant> for timeout-based display

---

## 2026-01-21 15:45 - US-008
- Implemented activity search/filter feature with '/' keybind to open search input
- Added InputMode::ActivitySearch variant for tracking search input state
- Added search state fields to App struct: activity_search_query, activity_search_cursor, activity_search_matches, activity_search_match_index
- Added matches_search() method to Activity struct for case-insensitive search matching
- Search modal features:
  - '/' opens search input when activity panel is focused
  - Enter to apply search and find matches
  - Esc to cancel search input
  - Standard text editing (Backspace, Delete, Left/Right arrows, Home/End)
- Activity list highlighting:
  - Current match highlighted in amber with » prefix
  - Other matches highlighted in amber with • prefix
  - Selected activity highlighted in cyan with ▸ prefix
- Header shows search status with match count (e.g., "[2/5 matches]")
- n/N keys to jump to next/previous match when search is active
- Esc clears search filter when activity panel is focused (before unfocusing panel)
- Updated hints panel to show search-related keybindings when appropriate
- Files changed: ralph-tui/src/main.rs, tasks/ralph-activity-control/prd.json
- **Learnings for future iterations:**
  - Search matches are stored as Vec<usize> containing indices into the activities list
  - Match highlighting requires checking both is_selected and is_search_match for proper styling
  - Keyboard handler priority: search mode should check for active search before notes editing for n key
  - Search state should be cleared both on Esc during input and on Esc when panel is focused

---

## 2026-01-21 16:30 - US-009
- Implemented attach mode improvements for full activity visibility and interactive control
- Activity parsing: Modified attach_to_tmux_session to store captured content in recent_output and call update_activities()
- Activity history panel: Replaced simple "Recent Activity" display with full scrollable activity panel (timestamps, selection, search)
- Inject prompt: Added tmux_send_keys() and tmux_send_enter() helpers to send input to tmux session
- Interactive mode: Added tmux_attach_interactive() helper that temporarily exits TUI, attaches to tmux, then restores TUI on detach
- Updated key handlers in run_attach_mode to support: activity panel focus (a), scrolling (j/k), search (/), prompt injection (Ctrl+P), interactive mode (Ctrl+I)
- Added activity search modal rendering in attach mode
- Updated footer bar to show contextual keybindings and mode indicator
- Files changed: ralph-tui/src/main.rs, tasks/ralph-activity-control/prd.json
- **Learnings for future iterations:**
  - tmux send-keys -l sends literal text (no special key interpretation), send-keys without -l interprets keys like "Enter"
  - tmux attach-session takes over stdio - need to disable_raw_mode/LeaveAlternateScreen before and restore after
  - PtyState.update_activities() parses new activities from recent_output - call after updating recent_output
  - Attach mode uses session_start for activity timestamps since there's no iteration_start

---
