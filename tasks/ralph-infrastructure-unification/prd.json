{
  "schemaVersion": "2.0",
  "project": "Ralph",
  "taskDir": "tasks/ralph-infrastructure-unification",
  "branchName": "ralph/ralph-infrastructure-unification",
  "mergeTarget": null,
  "autoMerge": false,
  "type": "feature",
  "description": "Ralph Infrastructure Unification - Rewrite ralph.sh as Python package, unify TUI communication via JSON-RPC, add interactive agent control, opencode stop-hook plugin, and branch management",
  "userStories": [
    {
      "id": "US-001",
      "title": "Python Package Scaffold",
      "description": "As a developer, I want the ralph Python package scaffolded with pyproject.toml and uv tool configuration so that the project can be installed as a CLI tool.",
      "acceptanceCriteria": [
        { "description": "Create pyproject.toml with [project.scripts] entry for ralph CLI", "passes": true },
        { "description": "Python 3.12+ requirement specified", "passes": true },
        { "description": "uv tool install . works and provides the ralph command", "passes": true },
        { "description": "Basic CLI entrypoint prints version and help", "passes": true },
        { "description": "Project uses src/ralph/ layout", "passes": true },
        { "description": "Typecheck passes", "passes": true }
      ],
      "priority": 1,
      "passes": true,
      "notes": "Package scaffolded with uv, hatchling build backend, mypy strict mode. CLI uses argparse with subcommands (run, status, stop, checkpoint, attach)."
    },
    {
      "id": "US-002",
      "title": "Core Loop Logic in Python",
      "description": "As a developer, I want the core iteration loop ported from bash to Python so it's maintainable and testable.",
      "acceptanceCriteria": [
        { "description": "Iteration loop spawns agent subprocess, waits for completion, checks results", "passes": true },
        { "description": "Supports max iteration count (configurable, default 50)", "passes": true },
        { "description": "Detects <promise>COMPLETE</promise> in agent output to stop loop", "passes": true },
        { "description": "Progress.txt rotation logic works (threshold configurable, default 300 lines)", "passes": true },
        { "description": "Consecutive failure tracking per agent works", "passes": true },
        { "description": "Graceful shutdown on SIGINT/SIGTERM", "passes": true },
        { "description": "Typecheck passes", "passes": true }
      ],
      "priority": 2,
      "passes": true,
      "notes": "Core loop implemented in src/ralph/loop.py. LoopRunner class handles iteration, agent subprocess spawning via shell agent scripts, stream-json output parsing, failure detection with error pattern matching, per-agent failover tracking, progress.txt rotation, and SIGINT/SIGTERM graceful shutdown."
    },
    {
      "id": "US-003",
      "title": "Agent Abstraction Layer",
      "description": "As a developer, I want a pluggable agent interface so ralph can run different coding agents (claude code, opencode) with agent-specific completion detection.",
      "acceptanceCriteria": [
        { "description": "Abstract Agent base class with start(), is_done(), get_output() methods", "passes": false },
        { "description": "ClaudeAgent implementation using claude --print --output-format stream-json", "passes": false },
        { "description": "OpencodeAgent implementation (placeholder, full implementation in US-008)", "passes": false },
        { "description": "Agent selection configurable per-task in prd.json and overridable at launch", "passes": false },
        { "description": "Failover logic: switch agents after N consecutive failures (configurable threshold)", "passes": false },
        { "description": "Typecheck passes", "passes": false }
      ],
      "priority": 3,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Branch Management",
      "description": "As a user, I want to specify what branch ralph starts from and what happens at the end of the loop so I have control over git workflow.",
      "acceptanceCriteria": [
        { "description": "ralph run --base-branch <branch> flag to specify starting branch", "passes": false },
        { "description": "If no base-branch specified, use current branch", "passes": false },
        { "description": "Ralph creates/checks out the task branch (from prd.json branchName) based off the specified base", "passes": false },
        { "description": "At loop completion: behavior controlled by prd.json mergeTarget and autoMerge fields", "passes": false },
        { "description": "If autoMerge true and mergeTarget set, ralph creates PR and merges automatically", "passes": false },
        { "description": "If autoMerge false and mergeTarget set, ralph creates PR but does not merge", "passes": false },
        { "description": "If no mergeTarget, loop just stops (branch left as-is)", "passes": false },
        { "description": "Branch state validated before starting (clean working tree required)", "passes": false },
        { "description": "Typecheck passes", "passes": false }
      ],
      "priority": 4,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-005",
      "title": "Session Management (tmux + SQLite)",
      "description": "As a user, I want ralph sessions to run in tmux with SQLite tracking so I can manage multiple concurrent loops.",
      "acceptanceCriteria": [
        { "description": "Ralph runs agent in a tmux session (one per task)", "passes": false },
        { "description": "SQLite registry at ~/.local/share/ralph/sessions.db tracks running sessions", "passes": false },
        { "description": "ralph status lists all running sessions (with --json flag for machine-readable output)", "passes": false },
        { "description": "ralph stop <task> sends graceful shutdown signal", "passes": false },
        { "description": "ralph checkpoint <task> saves state and pauses", "passes": false },
        { "description": "Session cleanup on normal completion or crash", "passes": false },
        { "description": "Typecheck passes", "passes": false }
      ],
      "priority": 5,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-006",
      "title": "Prompt Preprocessing",
      "description": "As a developer, I want the prompt.md template system ported to Python so agents receive properly formatted instructions.",
      "acceptanceCriteria": [
        { "description": "Loads prompt.md from task dir, then ~/.config/ralph/prompt.md, then bundled default", "passes": false },
        { "description": "Preprocesses template with task context (prd.json path, progress.txt path, branch info)", "passes": false },
        { "description": "Injects AGENTS.md content if present", "passes": false },
        { "description": "Passes final prompt to agent subprocess", "passes": false },
        { "description": "Supports the existing {VARIABLE} substitution pattern", "passes": false },
        { "description": "Typecheck passes", "passes": false }
      ],
      "priority": 6,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-007",
      "title": "TUI Communication Protocol (JSON-RPC over Unix Socket)",
      "description": "As a developer, I want a JSON-RPC communication protocol between ralph (Python) and ralph-tui (Rust) so the TUI can observe and control running loops.",
      "acceptanceCriteria": [
        { "description": "Ralph exposes a JSON-RPC server on a Unix domain socket per session (~/.local/share/ralph/sockets/<task>.sock)", "passes": false },
        { "description": "State queries: get_status returns current iteration, story, agent, interactive_mode flag, recent output", "passes": false },
        { "description": "Control commands: start, stop, checkpoint, inject_prompt, set_interactive_mode", "passes": false },
        { "description": "Event subscription: TUI can subscribe to real-time output stream and state changes", "passes": false },
        { "description": "Protocol documented in docs/protocol.md", "passes": false },
        { "description": "ralph-tui can still read prd.json and progress.txt directly for supplemental status", "passes": false },
        { "description": "Typecheck passes", "passes": false }
      ],
      "priority": 7,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-008",
      "title": "Opencode Stop-Hook Plugin",
      "description": "As a developer, I want an opencode plugin that signals when opencode completes an iteration so ralph can detect completion without polling.",
      "acceptanceCriteria": [
        { "description": "Opencode plugin written in TypeScript per opencode plugin API", "passes": false },
        { "description": "Plugin listens for session.idle event (fires when opencode finishes processing)", "passes": false },
        { "description": "Plugin reads RALPH_SIGNAL_FILE env var to discover where to write the signal", "passes": false },
        { "description": "Signal is a JSON file write: {event: idle, timestamp: iso, session_id: id}", "passes": false },
        { "description": "Ralph OpencodeAgent watches the signal file (inotify on Linux) for changes", "passes": false },
        { "description": "Completion only honored when interactive_mode is false", "passes": false },
        { "description": "Plugin loaded via .opencode/plugins/ directory (ralph copies it into task working directory before spawning opencode)", "passes": false },
        { "description": "Fallback: plugin can also be installed globally at ~/.config/opencode/plugins/", "passes": false },
        { "description": "Document plugin mechanism in README", "passes": false },
        { "description": "Typecheck passes", "passes": false }
      ],
      "priority": 8,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-012",
      "title": "Interactive Agent Control Mode",
      "description": "As a user, I want to pause the autonomous loop, interact directly with the agent (claude or opencode), and resume autonomous operation without triggering a false iteration completion.",
      "acceptanceCriteria": [
        { "description": "interactive_mode boolean tracked in session state, exposed via JSON-RPC", "passes": false },
        { "description": "Toggling interactive mode ON: sends agent pause key (Esc) through PTY, suppresses completion detection", "passes": false },
        { "description": "While interactive: user keystrokes forwarded directly to agent PTY", "passes": false },
        { "description": "Toggling interactive mode OFF: re-enables completion detection (agent continues from wherever user left it)", "passes": false },
        { "description": "Claude Code: interrupt via Esc, user types input, agent processes and continues", "passes": false },
        { "description": "Opencode: pause via Esc, user types input, agent processes and continues", "passes": false },
        { "description": "Signal file writes during interactive mode are queued/ignored until mode exits", "passes": false },
        { "description": "Output parsing for <promise>COMPLETE</promise> suppressed during interactive mode", "passes": false },
        { "description": "Both ralph-tui and ralph attach support this toggle with the same hotkey (i)", "passes": false },
        { "description": "Visual indicator in UI shows current mode (autonomous vs interactive)", "passes": false },
        { "description": "Typecheck passes", "passes": false }
      ],
      "priority": 9,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-009",
      "title": "TUI Loop Start Wizard",
      "description": "As a user, I want a full wizard in ralph-tui to start new loops so I don't need to use the CLI separately.",
      "acceptanceCriteria": [
        { "description": "Wizard accessible via hotkey in ralph-tui", "passes": false },
        { "description": "Step 1: Select task directory (list available tasks/ subdirectories)", "passes": false },
        { "description": "Step 2: Configure base branch (default: current branch, option to type another)", "passes": false },
        { "description": "Step 3: Set max iterations (default: 50, editable)", "passes": false },
        { "description": "Step 4: Select agent (claude/opencode, default from prd.json or claude)", "passes": false },
        { "description": "Step 5: Confirm and launch", "passes": false },
        { "description": "Wizard sends start command to ralph via JSON-RPC protocol", "passes": false },
        { "description": "New loop appears in TUI session list immediately", "passes": false },
        { "description": "Typecheck passes", "passes": false }
      ],
      "priority": 10,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-010",
      "title": "Ralph Attach (Single-Loop View)",
      "description": "As a user, I want ralph attach <task> to show a single-loop view similar to ralph-tui but focused on one session, with full agent interaction support.",
      "acceptanceCriteria": [
        { "description": "ralph attach <task> opens a terminal UI showing one running loop", "passes": false },
        { "description": "Shows: current iteration, story progress, live agent output", "passes": false },
        { "description": "Supports interactive mode toggle (hotkey i) for direct agent interaction", "passes": false },
        { "description": "In interactive mode: PTY input forwarded to agent, completion detection suppressed", "passes": false },
        { "description": "Exiting interactive mode (hotkey i again or Esc) re-enables autonomous monitoring", "passes": false },
        { "description": "Supports stop/checkpoint commands", "passes": false },
        { "description": "Exits cleanly when loop completes or user presses quit key", "passes": false },
        { "description": "Communicates with ralph loop via JSON-RPC protocol", "passes": false },
        { "description": "Part of the Python package (not a separate binary)", "passes": false },
        { "description": "Typecheck passes", "passes": false }
      ],
      "priority": 11,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-011",
      "title": "Migrate ralph.sh Functionality & Deprecation",
      "description": "As a developer, I want all ralph.sh functionality migrated to the Python version with the old script deprecated.",
      "acceptanceCriteria": [
        { "description": "All ralph.sh subcommands work in the Python version (run, attach, stop, checkpoint, status)", "passes": false },
        { "description": "ralph.sh renamed to ralph-legacy.sh with deprecation notice", "passes": false },
        { "description": "Existing task directories work without modification", "passes": false },
        { "description": "prd.json schema unchanged (both v1.0 and v2.0 supported)", "passes": false },
        { "description": "progress.txt format unchanged", "passes": false },
        { "description": "AGENTS.md update documenting migration", "passes": false },
        { "description": "Typecheck passes", "passes": false }
      ],
      "priority": 12,
      "passes": false,
      "notes": ""
    }
  ]
}
