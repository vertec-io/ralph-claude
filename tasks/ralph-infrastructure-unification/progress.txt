# Ralph Progress Log
Effort: ralph-infrastructure-unification
Type: Feature
Started: 2026-01-23

## Codebase Patterns
- Python package is `ralph-uv` with `src/ralph_uv/` layout and hatchling build backend
- CLI command is `ralph-uv` (not `ralph`) to coexist with ralph.sh
- pyproject.toml contains all tool config (mypy, ruff) - no separate config files
- CLI uses argparse with subparsers for subcommands
- uv is the package manager; `uv run ralph-uv` for dev, never install globally
- mypy runs in strict mode: `uv run mypy src/ralph_uv/`
- py.typed marker file present for PEP 561 compliance
- .gitignore uses /prd.json and /progress.txt (root-only) so task dir files are tracked
- Loop module (src/ralph_uv/loop.py) is the core: LoopConfig, LoopRunner
- Agent module (src/ralph_uv/agents.py): Agent ABC, ClaudeAgent, OpencodeAgent, FailureTracker, create_agent(), resolve_agent()
- Agent resolution priority: CLI --agent > story.agent > prd.agent > "claude" default
- LoopConfig.agent_override holds the CLI override; resolve_agent() does the priority logic
- Agents invoke CLIs directly (claude, opencode) - no shell script intermediaries
- Use `signal._HANDLER` type (not `signal.Handlers`) for signal handler storage
---

## 2026-01-23 - US-001: Python Package Scaffold
- Created src/ralph/__init__.py with __version__
- Created src/ralph/cli.py with argparse-based CLI (run, status, stop, checkpoint, attach subcommands)
- Created src/ralph/py.typed marker
- Created pyproject.toml with hatchling backend, Python >=3.12, [project.scripts] entry
- Added mypy as dev dependency, configured strict mode
- Updated .gitignore for Python artifacts and fixed prd.json/progress.txt patterns
- Files changed: pyproject.toml, src/ralph/__init__.py, src/ralph/cli.py, src/ralph/py.typed, .gitignore, uv.lock
- **Learnings for future iterations:**
  - uv creates a .venv directory automatically on first `uv run` - already in .gitignore
  - hatchling needs `packages = ["src/ralph"]` in [tool.hatch.build.targets.wheel] for src layout
  - Python 3.12+ enables match/case statements (used in CLI)
  - The project had Python 3.14 installed via mise - pyproject.toml requires >=3.12 so it's compatible
---

## 2026-01-23 - US-002: Core Loop Logic in Python
- Fixed mypy type errors in loop.py (signal handler types, Any returns)
- Added _cmd_run() function to cli.py to wire up LoopRunner
- Core loop module at src/ralph/loop.py already existed with:
  - LoopConfig dataclass (task_dir, max_iterations=50, agent, rotate_threshold=300, failover_threshold=3)
  - LoopRunner class with _run_loop(), _run_agent(), _rotate_progress_if_needed()
  - FailureTracker class for per-agent consecutive failure tracking + failover
  - IterationResult dataclass for structured agent output
  - SIGINT/SIGTERM handling with checkpoint writing
  - <promise>COMPLETE</promise> detection in agent output
  - Progress.txt rotation when exceeding threshold
- Files changed: src/ralph/cli.py, src/ralph/loop.py, tasks/ralph-infrastructure-unification/prd.json
- **Learnings for future iterations:**
  - signal.getsignal() returns `signal._HANDLER` type, not `signal.Handlers` - use `signal._HANDLER` for type annotations
  - For `dict[str, Any]` returns from json.loads(), use explicit type annotation on the receiving variable to avoid no-any-return
  - Use `str()` wrapper on `.get()` results to satisfy strict mypy return type checks
  - The agents/ directory contains bash wrapper scripts (claude.sh, opencode.sh) that accept prompts via stdin
  - ruff is configured in pyproject.toml but not installed as dev dependency (only mypy is)
---

## 2026-01-23 - US-001: Python Package Scaffold (rename to ralph-uv)
- Renamed src/ralph/ to src/ralph_uv/ to match PRD requirements
- Updated all imports from `ralph` to `ralph_uv`
- Updated pyproject.toml: project name to ralph-uv, scripts entry to ralph-uv, build packages to src/ralph_uv, mypy packages to ralph_uv
- Updated CLI prog name to ralph-uv, version string to ralph-uv
- Regenerated uv.lock for the renamed package
- Verified: `uv run ralph-uv --version` prints "ralph-uv 0.1.0"
- Verified: `uv run ralph-uv --help` shows all subcommands
- Verified: `uv run mypy src/ralph_uv/` passes with no errors
- Files changed: src/ralph_uv/ (renamed from src/ralph/), pyproject.toml, uv.lock, prd.json, progress.txt
- **Learnings for future iterations:**
  - Package import name is `ralph_uv` (underscore), CLI command is `ralph-uv` (hyphen)
  - After renaming a package, must regenerate uv.lock with `uv lock`
   - hatchling build target must match the actual directory: `packages = ["src/ralph_uv"]`
---

## 2026-01-23 - US-003: Agent Abstraction Layer
- Created src/ralph_uv/agents.py with Agent ABC, ClaudeAgent, OpencodeAgent, FailureTracker, create_agent(), resolve_agent()
- Agent base class has abstract start(), is_done(), get_output() methods + concrete run() convenience method
- ClaudeAgent: invokes `claude --print --output-format stream-json`, parses stream-json for result
- OpencodeAgent: invokes `opencode run`, placeholder for full implementation in US-008
- resolve_agent() implements priority: CLI --agent > story.agent > prd.agent > "claude" default
- FailureTracker moved from loop.py to agents.py (same logic, now co-located with agents)
- Refactored loop.py: removed _run_agent shell-script approach, _find_agents_dir, _extract_output, _detect_failure, _extract_error
- Added LoopConfig.agent_override field for CLI pass-through
- Updated cli.py to pass agent_override instead of resolved agent name
- mypy passes clean (4 source files, no errors)
- Files changed: src/ralph_uv/agents.py (new), src/ralph_uv/loop.py, src/ralph_uv/cli.py, prd.json
- **Learnings for future iterations:**
  - Agents invoke CLIs directly via subprocess.Popen - no need for bash wrapper scripts in agents/
  - Agent.run() handles the full lifecycle: start -> write prompt to stdin -> wait -> get_output
  - process.communicate() handles reading remaining stdout/stderr after stdin.close()
  - ClaudeAgent uses `--print` mode which reads prompt from stdin when piped
  - OpenCode uses `opencode run` which also reads prompt from stdin
  - The `data: dict[str, Any] = json.loads(line)` pattern satisfies mypy strict for json parsing
---
